<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Saisie Pro</title>
    <link rel="manifest" href="/static/app3/manifest.json">
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
            --table-head: #f8fafc;
            --sticky-csv-bg: #f0f7ff;
            --score-bg: #fffdf0;
            --remark-bg: #f0fdf4;
            --btn-text: #ffffff;
        }

        [data-theme="dark"] {
            --primary: #fbbf24;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --border: #334155;
            --table-head: #020617;
            --sticky-csv-bg: #1e293b;
            --score-bg: #0f172a;
            --remark-bg: #1e293b;
            --btn-text: #000000;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; transition: background 0.2s, color 0.2s; }
        body { background: var(--bg); color: var(--text); padding-bottom: 90px; }
        
        .header-card { background: var(--card); padding: 20px; border-bottom: 1px solid var(--border); margin-bottom: 10px; position: relative; }
        
        /* Theme Toggle Button */
        .theme-toggle {
            position: absolute; top: 15px; right: 15px;
            cursor: pointer; font-size: 24px; background: none; border: none;
            padding: 5px; border-radius: 50%;
        }

        /* Centralized Upload Zone */
        .upload-zone {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px 20px; border: 2px dashed var(--border); border-radius: 15px;
            margin: 20px auto; max-width: 400px; cursor: pointer; background: var(--card);
        }
        .upload-zone:active { transform: scale(0.98); }
        #excelFile { display: none; }

        /* Centered Sheet Selection */
        .sheet-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px; justify-content: center; align-items: center;
            max-width: 600px; margin: 15px auto;
        }

        /* Table Design */
        .table-outer { overflow-x: auto; background: var(--card); position: relative; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th, td { padding: 12px 8px; border-bottom: 1px solid var(--border); text-align: center; white-space: nowrap; font-size: 14px; }
        
        .sticky-name { position: sticky; left: 0; z-index: 10; background: var(--card); min-width: 150px; border-right: 2px solid var(--border); font-weight: bold; }
        th.sticky-name { background: var(--table-head); z-index: 11; }

        .sticky-csv { position: sticky; left: 0; z-index: 5; background: var(--sticky-csv-bg); min-width: 120px; border-right: 1px solid var(--border); }
        th.sticky-csv { background: var(--table-head); }

        .score-cell { background: var(--score-bg); min-width: 60px; }
        .remark-cell { font-weight: bold; color: var(--primary); min-width: 100px; background: var(--remark-bg); }

        /* UI Elements */
        .cell-input { width: 90%; padding: 6px; border: 1px solid var(--primary); border-radius: 4px; text-align: center; background: var(--card); color: var(--text); }
        .btn { background: var(--primary); color: var(--btn-text); border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }
        .btn-sheet { padding: 10px; font-size: 13px; text-align: center; }
        
        .footer { position: fixed; bottom: 0; width: 100%; background: var(--card); padding: 15px; border-top: 1px solid var(--border); z-index: 100; }
        .loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 999; justify-content: center; align-items: center; color: white; font-weight: bold; flex-direction: column; }
    </style>
</head>
<body>

<div id="loader" class="loader">
    <div style="margin-bottom: 10px;">Veuillez patienter...</div>
    <div style="font-size: 12px;">Mise Ã  jour des donnÃ©es</div>
</div>

<div class="header-card">
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">ðŸŒ™</button>
    <h2 style="font-size: 18px; text-align: center;">ðŸ“± Saisie des Notes</h2>
    
    <div id="uploadContainer" class="upload-zone" onclick="document.getElementById('excelFile').click()">
        <span style="font-size: 50px; margin-bottom: 10px;">ðŸ“„</span>
        <p id="uploadStatus">Cliquez ici pour sÃ©lectionner un fichier Excel</p>
        <input type="file" id="excelFile" accept=".xlsx" onchange="handleAutoUpload()" />
    </div>
</div>

<div id="sheetSelect" class="header-card" style="display:none; text-align: center;">
    <p style="font-weight: bold; margin-bottom: 10px;">SÃ©lectionner la classe:</p>
    <div id="sheetBtns" class="sheet-container"></div>
</div>

<div class="table-outer" id="tableContainer" style="display:none;">
    <table>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

<div class="footer" id="footer" style="display:none;">
    <button class="btn" onclick="saveFile()">ðŸ’¾ Enregistrer tout et TÃ©lÃ©charger</button>
</div>

<script>
    let currentData = [], currentHeaders = [], fileId = '', sheetName = '';
    const MAP = { CSV: 0, NOM: 2, PRENOM: 3, E: 5, F: 6, G: 7, H: 8, I: 9 };

    // Initial Theme Setup
    if (localStorage.getItem('theme') === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        document.getElementById('themeBtn').innerText = 'â˜€ï¸';
    }

    function toggleTheme() {
        const body = document.body;
        const btn = document.getElementById('themeBtn');
        if (body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme');
            btn.innerText = 'ðŸŒ™';
            localStorage.setItem('theme', 'light');
        } else {
            body.setAttribute('data-theme', 'dark');
            btn.innerText = 'â˜€ï¸';
            localStorage.setItem('theme', 'dark');
        }
    }

    function handleAutoUpload() {
        const fileInput = document.getElementById('excelFile');
        const file = fileInput.files[0];
        if(!file) return;

        document.getElementById('uploadStatus').innerText = "Importation en cours...";
        const fd = new FormData(); 
        fd.append('file', file);
        
        fetch('/upload', { method: 'POST', body: fd })
        .then(r => r.json()).then(res => {
            fileId = res.file_id;
            const container = document.getElementById('sheetBtns');
            container.innerHTML = '';
            res.sheet_names.forEach(n => {
                const b = document.createElement('button');
                b.className = 'btn btn-sheet'; 
                b.textContent = n;
                b.onclick = () => loadSheet(n);
                container.appendChild(b);
            });
            document.getElementById('sheetSelect').style.display = 'block';
            document.getElementById('uploadContainer').style.display = 'none';
        }).catch(() => {
            document.getElementById('uploadStatus').innerText = "Erreur. RÃ©essayez.";
        });
    }

    async function loadSheet(name) {
        if(name === sheetName) return;
        document.getElementById('loader').style.display = 'flex';

        // Auto-sync current changes to server before switching
        if (sheetName !== '' && currentData.length > 0) {
            await syncData();
        }

        const encodedName = encodeURIComponent(name);
        fetch(`/get_sheet_data/${fileId}/${encodedName}`)
        .then(r => r.json()).then(res => {
            sheetName = name;
            currentHeaders = res.headers;
            currentData = res.data;
            render();
            document.getElementById('tableContainer').style.display = 'block';
            document.getElementById('footer').style.display = 'block';
            document.getElementById('loader').style.display = 'none';
            
            // Highlight active sheet
            document.querySelectorAll('.btn-sheet').forEach(b => {
                b.style.opacity = b.textContent === name ? '1' : '0.6';
                b.style.border = b.textContent === name ? '2px solid white' : 'none';
            });
        });
    }

    function syncData() {
        const updates = [];
        currentData.forEach((row, rIdx) => {
            [5,6,7,8].forEach(c => updates.push({row_index: rIdx, column_index: c, value: row[c]}));
            const avg = calculateRow(rIdx);
            updates.push({row_index: rIdx, column_index: 9, value: getRemark(avg)});
        });
        return fetch('/update_sheet_in_memory', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({file_id: fileId, sheet_name: sheetName, updated_data: updates})
        }).then(r => r.json());
    }

    function render() {
        const thead = document.getElementById('thead');
        const tbody = document.getElementById('tbody');
        thead.innerHTML = `<tr>
            <th class="sticky-name">Nom et PrÃ©nom</th>
            <th class="sticky-csv">Saisie CSV</th>
            <th>${currentHeaders[MAP.E]}</th><th>${currentHeaders[MAP.F]}</th>
            <th>${currentHeaders[MAP.G]}</th><th>${currentHeaders[MAP.H]}</th>
            <th style="background:var(--border); color:var(--text)">${currentHeaders[MAP.I]}</th>
        </tr>`;

        tbody.innerHTML = '';
        currentData.forEach((row, rIdx) => {
            const tr = document.createElement('tr');
            tr.innerHTML += `<td class="sticky-name">${row[MAP.NOM]} ${row[MAP.PRENOM]}</td>`;
            const tdCsv = document.createElement('td');
            tdCsv.className = 'sticky-csv';
            tdCsv.innerHTML = row[0] || '';
            tdCsv.onclick = () => edit(tdCsv, rIdx, 0);
            tr.appendChild(tdCsv);

            [MAP.E, MAP.F, MAP.G, MAP.H].forEach(cIdx => {
                const td = document.createElement('td');
                td.className = 'score-cell';
                td.innerHTML = row[cIdx] || '';
                td.onclick = () => edit(td, rIdx, cIdx);
                tr.appendChild(td);
            });

            const tdI = document.createElement('td');
            tdI.className = 'remark-cell';
            const avg = calculateRow(rIdx);
            tdI.textContent = getRemark(avg);
            tr.appendChild(tdI);
            tbody.appendChild(tr);
        });
    }

    function edit(td, rIdx, cIdx) {
        if (td.querySelector('input')) return;
        const old = td.innerText;
        td.innerHTML = `<input type="text" class="cell-input" value="${old}" onblur="update(${rIdx},${cIdx},this.value)">`;
        td.querySelector('input').focus();
    }

    function update(rIdx, cIdx, val) {
        currentData[rIdx][cIdx] = val;
        if (cIdx === 0) {
            const parts = val.split(/\s+/);
            if(parts[0]) currentData[rIdx][MAP.E] = parts[0];
            if(parts[1]) currentData[rIdx][MAP.F] = parts[1];
            if(parts[2]) currentData[rIdx][MAP.G] = parts[2];
            if(parts[3]) currentData[rIdx][MAP.H] = parts[3];
        }
        render();
    }

    function calculateRow(rIdx) {
        const r = currentData[rIdx];
        const e = parseFloat(r[MAP.E]) || 0, f = parseFloat(r[MAP.F]) || 0, 
              g = parseFloat(r[MAP.G]) || 0, h = parseFloat(r[MAP.H]) || 0;
        const result = (e + f + g + (2 * h)) / 5;
        return result > 0 ? result : null;
    }

    function getRemark(avg) {
        if (!avg && avg !== 0) return "";
        if (avg < 10) return "Ø¯ÙˆÙ† Ø§Ù„ÙˆØ³Ø·";
        if (avg < 12) return "Ù…ØªÙˆØ³Ø·";
        if (avg < 14) return "Ù„Ø§Ø¨Ø§Ø³";
        if (avg < 16) return "Ø¬ÙŠØ¯";
        if (avg < 19) return "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§";
        return "Ù…Ù…ØªØ§Ø²";
    }

    async function saveFile() {
        document.getElementById('loader').style.display = 'flex';
        await syncData();
        fetch('/save_file', {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({file_id: fileId})
        }).then(r => r.blob()).then(b => {
            const a = document.createElement('a'); a.href = URL.createObjectURL(b);
            a.download = "notes_complet.xlsx"; a.click();
            document.getElementById('loader').style.display = 'none';
        });
    }
</script>
</body>
</html>
